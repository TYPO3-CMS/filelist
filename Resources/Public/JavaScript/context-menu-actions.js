/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import{lll as a}from"@typo3/core/lit-helper.js";import{SeverityEnum as g}from"@typo3/backend/enum/severity.js";import c from"@typo3/core/ajax/ajax-request.js";import s from"@typo3/backend/notification.js";import C from"@typo3/backend/modal.js";import m from"@typo3/backend/hashing/md5.js";import{fileListOpenElementBrowser as U}from"@typo3/filelist/file-list.js";import{FileListActionUtility as f,FileListActionEvent as u}from"@typo3/filelist/file-list-actions.js";class i{static getReturnUrl(){return encodeURIComponent(top.list_frame.document.location.pathname+top.list_frame.document.location.search)}static triggerFileDownload(r,t,e=!1){const n=document.createElement("a");n.href=r,n.download=t,document.body.appendChild(n),n.click(),e&&URL.revokeObjectURL(r),document.body.removeChild(n),s.success(a("file_download.success"),"",2)}static renameFile(r,t,e){(async()=>{await import("@typo3/filelist/file-list-rename-handler.js");const n=f.createResourceFromContextDataset(e),o={event:null,trigger:null,action:u.rename,resources:[n],url:null,originalAction:null};document.dispatchEvent(new CustomEvent(u.rename,{detail:o}))})()}static replaceFile(r,t,e){(async()=>{await import("@typo3/filelist/file-list-replace-handler.js");const n=f.createResourceFromContextDataset(e),o={event:null,trigger:null,action:u.rename,resources:[n],url:null,originalAction:null};document.dispatchEvent(new CustomEvent(u.replace,{detail:o}))})()}static editFile(r,t,e){const n=e.actionUrl;top.TYPO3.Backend.ContentContainer.setUrl(n+"&target="+encodeURIComponent(t)+"&returnUrl="+i.getReturnUrl())}static editMetadata(r,t,e){const n=f.createResourceFromContextDataset(e);n.metaUid&&top.TYPO3.Backend.ContentContainer.setUrl(top.TYPO3.settings.FormEngine.moduleUrl+"&edit[sys_file_metadata]["+n.metaUid+"]=edit&module="+encodeURIComponent(top.TYPO3.ModuleMenu.App.getCurrentModule())+"&returnUrl="+i.getReturnUrl())}static openInfoPopUp(r,t){r==="sys_file_storage"?top.TYPO3.InfoWindow.showItem(r,t):top.TYPO3.InfoWindow.showItem("_FILE",t)}static createFolder(r,t,e){top.TYPO3.Backend.ContentContainer.get().document.dispatchEvent(new CustomEvent(U,{detail:{actionUrl:e.actionUrl,identifier:e.identifier,mode:e.mode}}))}static createFile(r,t,e){top.TYPO3.Backend.ContentContainer.get().document.dispatchEvent(new CustomEvent(U,{detail:{actionUrl:e.actionUrl,identifier:e.identifier,mode:e.mode}}))}static downloadFile(r,t,e){i.triggerFileDownload(e.url,e.name)}static downloadFolder(r,t,e){s.info(a("file_download.prepare"),"",2);const n=e.actionUrl;new c(n).post({items:[t]}).then(async o=>{let l=o.response.headers.get("Content-Disposition");if(!l){const d=await o.resolve();d.success===!1&&d.status?s.warning(a("file_download."+d.status),a("file_download."+d.status+".message"),10):s.error(a("file_download.error"));return}l=l.substring(l.indexOf(" filename=")+10);const p=await o.raw().arrayBuffer(),b=new Blob([p],{type:o.raw().headers.get("Content-Type")});i.triggerFileDownload(URL.createObjectURL(b),l,!0)}).catch(()=>{s.error(a("file_download.error"))})}static createFilemount(r,t){t.split(":").length===2&&top.TYPO3.Backend.ContentContainer.setUrl(top.TYPO3.settings.FormEngine.moduleUrl+"&edit[sys_filemounts][0]=new&defVals[sys_filemounts][identifier]="+encodeURIComponent(t)+"&returnUrl="+i.getReturnUrl())}static deleteFile(r,t,e){const n=()=>{top.TYPO3.Backend.ContentContainer.setUrl(top.TYPO3.settings.FileCommit.moduleUrl+"&data[delete][0][data]="+encodeURIComponent(t)+"&data[delete][0][redirect]="+i.getReturnUrl())};if(!e.title){n();return}const o=C.confirm(e.title,e.message,g.warning,[{text:e.buttonCloseText||TYPO3.lang["button.cancel"]||"Cancel",active:!0,btnClass:"btn-default",name:"cancel"},{text:e.buttonOkText||TYPO3.lang["button.delete"]||"Delete",btnClass:"btn-warning",name:"delete"}]);o.addEventListener("button.clicked",l=>{l.target.name==="delete"&&n(),o.hideModal()})}static copyFile(r,t){const e=m.hash(t),n=TYPO3.settings.ajaxUrls.contextmenu_clipboard,o={CB:{el:{["_FILE%7C"+e]:t},setCopyMode:"1"}};new c(n).withQueryArguments(o).get().finally(()=>{top.TYPO3.Backend.ContentContainer.refresh()})}static copyReleaseFile(r,t){const e=m.hash(t),n=TYPO3.settings.ajaxUrls.contextmenu_clipboard,o={CB:{el:{["_FILE%7C"+e]:"0"},setCopyMode:"1"}};new c(n).withQueryArguments(o).get().finally(()=>{top.TYPO3.Backend.ContentContainer.refresh()})}static cutFile(r,t){const e=m.hash(t),n=TYPO3.settings.ajaxUrls.contextmenu_clipboard,o={CB:{el:{["_FILE%7C"+e]:t}}};new c(n).withQueryArguments(o).get().finally(()=>{top.TYPO3.Backend.ContentContainer.refresh()})}static cutReleaseFile(r,t){const e=m.hash(t),n=TYPO3.settings.ajaxUrls.contextmenu_clipboard,o={CB:{el:{["_FILE%7C"+e]:"0"}}};new c(n).withQueryArguments(o).get().finally(()=>{top.TYPO3.Backend.ContentContainer.refresh()})}static pasteFileInto(r,t,e){const n=()=>{top.TYPO3.Backend.ContentContainer.setUrl(top.TYPO3.settings.FileCommit.moduleUrl+"&CB[paste]=FILE|"+encodeURIComponent(t)+"&CB[pad]=normal&redirect="+i.getReturnUrl())};if(!e.title){n();return}const o=C.confirm(e.title,e.message,g.warning,[{text:e.buttonCloseText||TYPO3.lang["button.cancel"]||"Cancel",active:!0,btnClass:"btn-default",name:"cancel"},{text:e.buttonOkText||TYPO3.lang["button.ok"]||"OK",btnClass:"btn-warning",name:"ok"}]);o.addEventListener("button.clicked",l=>{l.target.name==="ok"&&n(),o.hideModal()})}static updateOnlineMedia(r,t,e){if(!e.actionUrl||!e.filecontextUid||e.filecontextType!=="file")return;const n={resource:{type:e.filecontextType,uid:e.filecontextUid}};new c(e.actionUrl).post(n).then(()=>{s.success(a("online_media.update.success"))}).catch(()=>{s.error(a("online_media.update.error"))}).finally(()=>{window.location.reload()})}}export{i as default};
