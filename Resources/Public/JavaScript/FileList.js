/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","TYPO3/CMS/Core/DocumentService","TYPO3/CMS/Backend/Notification","TYPO3/CMS/Backend/InfoWindow","TYPO3/CMS/Backend/BroadcastMessage","TYPO3/CMS/Backend/BroadcastService","TYPO3/CMS/Backend/Tooltip","TYPO3/CMS/Core/Event/RegularEvent","TYPO3/CMS/Backend/Storage/ModuleStateStorage","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Backend/Enum/Severity","TYPO3/CMS/Backend/Severity"],(function(e,t,o,i,n,r,a,l,c,s,d,u,m){"use strict";var f;!function(e){e.fileListFormSelector='form[name="fileListForm"]',e.commandSelector='input[name="cmd"]',e.searchFieldSelector='input[name="searchTerm"]',e.pointerFieldSelector='input[name="pointer"]'}(f||(f={}));class p{static submitClipboardFormWithCommand(e,t){const o=t.closest(f.fileListFormSelector);if(!o)return;const i=o.querySelector(f.commandSelector);if(i){if(i.value=e,"setCB"===e){const e=o.querySelector(f.pointerFieldSelector),t=p.parseQueryParameters(document.location).pointer;e&&t&&(e.value=t)}o.submit()}}static openInfoPopup(e,t){n.showItem(e,t)}static processTriggers(){const e=document.querySelector(".filelist-main");if(null===e)return;const t=encodeURIComponent(e.dataset.filelistCurrentIdentifier);s.ModuleStateStorage.update("file",t,!0,void 0),p.emitTreeUpdateRequest(e.dataset.filelistCurrentIdentifier)}static emitTreeUpdateRequest(e){const t=new r.BroadcastMessage("filelist","treeUpdateRequested",{type:"folder",identifier:e});a.post(t)}static parseQueryParameters(e){let t={};if(e&&Object.prototype.hasOwnProperty.call(e,"search")){let o=e.search.substr(1).split("&");for(let e=0;e<o.length;e++){const i=o[e].split("=");t[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}}return t}static getReturnUrl(e){return""===e&&(e=top.list_frame.document.location.pathname+top.list_frame.document.location.search),encodeURIComponent(e)}constructor(){var e;p.processTriggers(),o.ready().then(()=>{l.initialize(".table-fit a[title]"),new c("click",(e,t)=>{e.preventDefault(),p.openInfoPopup(t.dataset.filelistShowItemType,t.dataset.filelistShowItemIdentifier)}).delegateTo(document,"[data-filelist-show-item-identifier][data-filelist-show-item-type]"),new c("click",(e,t)=>{e.preventDefault(),p.openInfoPopup("_FILE",t.dataset.identifier)}).delegateTo(document,"a.filelist-file-info"),new c("click",(e,t)=>{e.preventDefault(),p.openInfoPopup("_FILE",t.dataset.identifier)}).delegateTo(document,"a.filelist-file-references"),new c("click",(e,t)=>{e.preventDefault();const o=t.getAttribute("href");let i=o?encodeURIComponent(o):encodeURIComponent(top.list_frame.document.location.pathname+top.list_frame.document.location.search);top.list_frame.location.href=o+"&redirect="+i}).delegateTo(document,"a.filelist-file-copy")}),new c("multiRecordSelection:action:edit",this.editFileMetadata).bindTo(document),new c("multiRecordSelection:action:delete",this.deleteMultiple).bindTo(document),new c("multiRecordSelection:action:setCB",e=>{p.submitClipboardFormWithCommand("setCB",e.target)}).bindTo(document);const t=""!==(null===(e=document.querySelector([f.fileListFormSelector,f.searchFieldSelector].join(" ")))||void 0===e?void 0:e.value);new c("search",e=>{var o;const i=e.target;""===i.value&&t&&(null===(o=i.closest(f.fileListFormSelector))||void 0===o||o.submit())}).delegateTo(document,f.searchFieldSelector)}deleteMultiple(e){e.preventDefault();const t=e.detail.configuration;d.advanced({title:t.title||"Delete",content:t.content||"Are you sure you want to delete those files and folders?",severity:u.SeverityEnum.warning,buttons:[{text:TYPO3.lang["button.close"]||"Close",active:!0,btnClass:"btn-default",trigger:()=>d.currentModal.trigger("modal-dismiss")},{text:t.ok||TYPO3.lang["button.ok"]||"OK",btnClass:"btn-"+m.getCssClass(u.SeverityEnum.warning),trigger:()=>{p.submitClipboardFormWithCommand("delete",e.target),d.currentModal.trigger("modal-dismiss")}}]})}editFileMetadata(e){e.preventDefault();const t=e.detail,o=t.configuration;if(!o||!o.idField||!o.table)return;const n=[];t.checkboxes.forEach(e=>{const t=e.closest("tr");null!==t&&t.dataset[o.idField]&&n.push(t.dataset[o.idField])}),n.length?window.location.href=top.TYPO3.settings.FormEngine.moduleUrl+"&edit["+o.table+"]["+n.join(",")+"]=edit&returnUrl="+p.getReturnUrl(o.returnUrl||""):i.warning("The selected elements can not be edited.")}}return new p}));